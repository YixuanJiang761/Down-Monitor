<script>
        // Load initial data from Python
        const INITIAL_DATA = {{ initial_data | tojson | safe }};

        function getBarColor(ms, status) {
            if (status !== 'up') return 'var(--red)';
            if (ms > 500) return 'var(--yellow)';
            return 'var(--green)';
        }

        function updateDisplay(data) {
            const grid = document.getElementById('grid');
            if (data.last_check) {
                document.getElementById('lastCheck').innerText = "Last checked: " + new Date(data.last_check).toLocaleTimeString();
            }

            if (!data.sites) return;
            
            grid.innerHTML = ''; 

            // REMOVED .sort() TO KEEP PYTHON ORDER
            Object.keys(data.sites).forEach(name => {
                const site = data.sites[name];
                const history = site.history || [];
                
                // --- Generate Bars (20 items) ---
                let barsHtml = '';
                for (let i = 0; i < 20; i++) {
                    const idx = history.length - (20 - i);
                    let style = 'height: 4px; background: #334155';
                    let tooltip = 'No Data';

                    if (idx >= 0) {
                        const point = history[idx];
                        let pct = Math.min((point.time / 1000) * 100, 100);
                        if (point.status !== 'up') pct = 100;
                        pct = Math.max(pct, 15);

                        const color = getBarColor(point.time, point.status);
                        style = `height: ${pct}%; background: ${color}`;
                        tooltip = `${point.time}ms`;
                    }
                    barsHtml += `<div class="bar" style="${style}" title="${tooltip}"></div>`;
                }

                // --- Pie Chart Style ---
                const pieStyle = `background: conic-gradient(var(--green) 0% ${site.uptime}%, #334155 ${site.uptime}% 100%)`;
                const statusColor = site.current.status === 'up' ? 'var(--green)' : 'var(--red)';
                const statusText = site.current.status === 'up' ? site.current.time + 'ms' : 'DOWN';

                const card = document.createElement('div');
                card.className = 'service-card';
                card.innerHTML = `
                    <div class="card-top">
                        <div class="info-group">
                            <span class="name">${name}</span>
                            <a href="${site.url}" target="_blank" class="url">Visit Site &rarr;</a>
                        </div>
                        <div class="uptime-group">
                            <span class="val">${site.uptime}%</span>
                            <div class="pie" style="${pieStyle}"></div>
                        </div>
                    </div>

                    <div class="card-bottom">
                        <div class="history-wrapper">
                            <div class="history-label">Response Time (Last 10m)</div>
                            <div class="bars">${barsHtml}</div>
                        </div>
                        <div class="status-badge" style="color: ${statusColor}">
                            ${statusText}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Initialize
        if (INITIAL_DATA) updateDisplay(INITIAL_DATA);

        // Auto-refresh
        setInterval(async () => {
            try {
                const res = await fetch('/api/status');
                updateDisplay(await res.json());
            } catch(e) { console.error(e); }
        }, 30000);
    </script>